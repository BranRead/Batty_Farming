[gd_scene load_steps=23 format=2]

[ext_resource path="res://images/02_PixelSky_1920x1080.png" type="Texture" id=1]
[ext_resource path="res://LeftScreen.gd" type="Script" id=2]
[ext_resource path="res://RightScreen.gd" type="Script" id=3]
[ext_resource path="res://TopScreen.gd" type="Script" id=4]
[ext_resource path="res://BottomScreen.gd" type="Script" id=5]
[ext_resource path="res://Mouse.gd" type="Script" id=6]
[ext_resource path="res://images/batIcon.png" type="Texture" id=7]
[ext_resource path="res://MoneyLabel.gd" type="Script" id=8]
[ext_resource path="res://audio/320144__owlstorm__blanket-movement-6.wav" type="AudioStream" id=9]
[ext_resource path="res://audio/buybat.mp3" type="AudioStream" id=10]
[ext_resource path="res://audio/fooddrop.mp3" type="AudioStream" id=11]
[ext_resource path="res://audio/click.mp3" type="AudioStream" id=12]
[ext_resource path="res://audio/rain-sound-and-rainforest-6293.mp3" type="AudioStream" id=13]
[ext_resource path="res://audio/atmospheric-soundscape-152493.mp3" type="AudioStream" id=14]
[ext_resource path="res://images/topPanel.png" type="Texture" id=15]
[ext_resource path="res://images/moneyPanel.png" type="Texture" id=16]
[ext_resource path="res://images/foodIcon.png" type="Texture" id=17]

[sub_resource type="GDScript" id=1]
script/source = "extends Node
var food_packed_scene = preload(\"Food.tscn\")
var bat_packed_scene = preload(\"Bat.tscn\")
var rng = RandomNumberGenerator.new()
var guano_collected : int = 0
var is_mouse_touching_something : bool = false 
var money : float = 2.00
var food_allowed_onscreen: int = 1
var food_quantity_upgrade_cost : float = 1.50
var food_quality_upgrade_cost : float = 2.50
var food_quality_level = 1
export var summon_buffer : int = 200

onready var collect_guano : AudioStreamPlayer = $CollectGuano
onready var food_drop : AudioStreamPlayer = $FoodDrop
onready var buy_bat : AudioStreamPlayer = $BuyBat
onready var click : AudioStreamPlayer = $Click
onready var rain : AudioStreamPlayer = $Rain
onready var piano : AudioStreamPlayer = $Piano
onready var grapes = load(\"res://images/grapes.png\")

onready var bananas = load(\"res://images/bananas.png\")


# Called when the node enters the scene tree for the first time.
func _ready():
	rng.randomize()
	rain.play()
	piano.play()
	for n in 2:
		var bat = bat_packed_scene.instance()
		var batDouble = bat.duplicate()
		batDouble.position = Vector2(rng.randi_range(summon_buffer, get_viewport().get_visible_rect().size.x - summon_buffer), rng.randi_range(summon_buffer, get_viewport().get_visible_rect().size.y - summon_buffer))
		add_child(batDouble)

# Called every frame. 'delta' is the elapsed time since the previous frame.
func _process(delta):
	if Input.is_action_just_pressed(\"click\") && !is_mouse_touching_something:
		var mouse_position = get_viewport().get_mouse_position()
		var food = food_packed_scene.instance()
		var food_on_screen = get_tree().get_nodes_in_group(\"food\")
		if check_money(food.cost):
			if food_on_screen.size() < food_allowed_onscreen:
				food.position = mouse_position
				self.money -= food.cost
				$MoneyLabel.update_money()
				food.add_to_group(\"food\", true)
				add_child(food)
		else:
			no_more_money();
		
	if Input.is_action_just_pressed(\"right_click\"):
		self.money += 10
		var mouse_position = get_viewport().get_mouse_position()
		var bat = bat_packed_scene.instance()
		#This is the most important part 
		#Otherwise the bats all share the same script
		var batDouble = bat.duplicate()
		batDouble.position = mouse_position
		add_child(batDouble)


func _on_Mouse_area_entered(area):
	#print(\"Can't drop food\")
	is_mouse_touching_something = true


func _on_Mouse_area_exited(area):
	#print(\"Can drop food\")
	is_mouse_touching_something = false


func _on_BatButton_pressed():
	click.play();
	var bat = bat_packed_scene.instance()
	if check_money(bat.cost):
			#This is the most important part 
			#Otherwise the bats all share the same script
			var batDouble = bat.duplicate()
			batDouble.position = Vector2(rng.randi_range(summon_buffer, get_viewport().get_visible_rect().size.x - summon_buffer), rng.randi_range(summon_buffer, get_viewport().get_visible_rect().size.y - summon_buffer))
			self.money -= bat.cost
			$MoneyLabel.update_money()
			add_child(batDouble)
	else:
		no_more_money();


func _on_BottomScreen_area_entered(area):
	if area.name_check == \"guano\":
		area.is_fallen_off_screen = true
	if area.name_check == \"food\" || area.name_check == \"guano\":
		area.queue_free()
	
func no_more_money():
	$TextureRect/NoMoney.play(\"NoMoney\")
	
func check_money(itemCost):
	return self.money > itemCost || is_equal_approx(self.money, itemCost)
	
func _on_Main_child_exiting_tree(node):
	if node.name_check == \"guano\":
		if !node.is_fallen_off_screen:
			collect_guano.play()

func _on_Main_child_entered_tree(node):
	if node is Area2D:
		if node.name_check == \"bat\":
			buy_bat.play()
		elif node.name_check == \"food\":
			food_drop.play()
		


func _on_FoodDropQuantityButton_pressed():
	if food_allowed_onscreen < 10:
		click.play();
		if check_money(food_quantity_upgrade_cost):
			self.food_allowed_onscreen += 1
			self.money -= food_quantity_upgrade_cost
			$MoneyLabel.update_money()
			$FoodDropQuantityButton.text = \"X\" + str(food_allowed_onscreen)
			if food_allowed_onscreen == 10:
				$FoodDropQuantityButton/Label.text = \"MAX\"
				$FoodDropQuantityButton.mouse_default_cursor_shape = Control.CURSOR_ARROW


func _on_FoodUpgradeButton_pressed():
	if food_quality_level < 3:
		click.play();
		if check_money(food_quality_upgrade_cost):
			food_quality_level += 1
			$MoneyLabel.update_money()
			if food_quality_level < 3: 
				$FoodUpgradeButton.icon = grapes
			else:
				$FoodUpgradeButton.icon = bananas
				$FoodUpgradeButton/Label.text = \"MAX\"
				$FoodUpgradeButton.mouse_default_cursor_shape = Control.CURSOR_ARROW
"

[sub_resource type="RectangleShape2D" id=2]
extents = Vector2( 74, 538 )

[sub_resource type="RectangleShape2D" id=3]
extents = Vector2( 956, 75 )

[sub_resource type="CircleShape2D" id=4]

[sub_resource type="Animation" id=5]
resource_name = "NoMoney"
tracks/0/type = "value"
tracks/0/path = NodePath(".:self_modulate")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/keys = {
"times": PoolRealArray( 0.2, 0.4, 0.6, 0.8 ),
"transitions": PoolRealArray( 1, 1, 1, 1 ),
"update": 0,
"values": [ Color( 1, 0, 0, 1 ), Color( 1, 1, 1, 1 ), Color( 1, 0, 0, 1 ), Color( 1, 1, 1, 1 ) ]
}

[node name="Main" type="Node"]
script = SubResource( 1 )
summon_buffer = 301

[node name="CanvasLayer" type="CanvasLayer" parent="."]
layer = -1

[node name="BlankScreen" type="Node2D" parent="CanvasLayer"]
z_index = -10

[node name="ColorRect" type="ColorRect" parent="CanvasLayer/BlankScreen"]
show_behind_parent = true
margin_right = 1917.0
margin_bottom = 1079.0
mouse_filter = 2
color = Color( 0.211765, 0.219608, 0.219608, 1 )

[node name="Sprite" type="Sprite" parent="CanvasLayer"]
position = Vector2( 960, 530 )
scale = Vector2( 0.9, 0.9 )
z_index = -1
texture = ExtResource( 1 )

[node name="SideBar2" type="TextureRect" parent="CanvasLayer"]
margin_left = 1068.0
margin_top = 549.0
margin_right = 2980.0
margin_bottom = 699.0
rect_rotation = 90.0
rect_pivot_offset = Vector2( 695.728, 150 )
texture = ExtResource( 15 )
expand = true
stretch_mode = 1

[node name="SideBar" type="TextureRect" parent="CanvasLayer"]
margin_left = -697.0
margin_top = 551.0
margin_right = 1215.0
margin_bottom = 701.0
rect_rotation = 90.0
rect_pivot_offset = Vector2( 695.728, 150 )
texture = ExtResource( 15 )
expand = true
stretch_mode = 1

[node name="TopBar" type="TextureRect" parent="CanvasLayer"]
margin_right = 1912.0
margin_bottom = 150.0
rect_pivot_offset = Vector2( -1022, -552 )
texture = ExtResource( 15 )
expand = true
stretch_mode = 1

[node name="LeftScreen" type="Area2D" parent="CanvasLayer"]
visible = false
script = ExtResource( 2 )

[node name="CollisionShape2D" type="CollisionShape2D" parent="CanvasLayer/LeftScreen"]
position = Vector2( 75, 540.5 )
shape = SubResource( 2 )

[node name="RightScreen" type="Area2D" parent="CanvasLayer"]
visible = false
script = ExtResource( 3 )

[node name="CollisionShape2D2" type="CollisionShape2D" parent="CanvasLayer/RightScreen"]
position = Vector2( 1838.5, 540 )
shape = SubResource( 2 )

[node name="TopScreen" type="Area2D" parent="CanvasLayer"]
visible = false
position = Vector2( 694, -137 )
script = ExtResource( 4 )

[node name="CollisionShape2D" type="CollisionShape2D" parent="CanvasLayer/TopScreen"]
position = Vector2( 262, 212 )
shape = SubResource( 3 )

[node name="BottomScreen" type="Area2D" parent="CanvasLayer"]
visible = false
position = Vector2( 1388, -274 )
script = ExtResource( 5 )

[node name="CollisionShape2D" type="CollisionShape2D" parent="CanvasLayer/BottomScreen"]
position = Vector2( -426, 1337 )
shape = SubResource( 3 )

[node name="Mouse" type="Area2D" parent="."]
script = ExtResource( 6 )

[node name="CollisionShape2D" type="CollisionShape2D" parent="Mouse"]
scale = Vector2( 0.5, 0.5 )
shape = SubResource( 4 )

[node name="BatButton" type="Button" parent="."]
margin_left = 353.0
margin_top = 25.0
margin_right = 553.0
margin_bottom = 125.0
hint_tooltip = "Click here to buy a bat!"
mouse_default_cursor_shape = 2
icon = ExtResource( 7 )
icon_align = 1

[node name="Label" type="Label" parent="BatButton"]
margin_top = 64.0
margin_right = 200.0
margin_bottom = 100.0
rect_pivot_offset = Vector2( 100, 387 )
text = "Bat: $1.00"
align = 1
valign = 1

[node name="FoodDropQuantityButton" type="Button" parent="."]
margin_left = 563.0
margin_top = 25.0
margin_right = 763.0
margin_bottom = 125.0
rect_pivot_offset = Vector2( 108, 163 )
hint_tooltip = "The amount of food you can drop at once"
mouse_default_cursor_shape = 2
text = "X1"

[node name="Label" type="Label" parent="FoodDropQuantityButton"]
margin_top = 64.0
margin_right = 200.0
margin_bottom = 100.0
rect_pivot_offset = Vector2( 100, 387 )
text = "Food Quantity: $1.50"
align = 1
valign = 1

[node name="FoodUpgradeButton" type="Button" parent="."]
margin_left = 773.0
margin_top = 25.0
margin_right = 973.0
margin_bottom = 125.0
rect_pivot_offset = Vector2( 108, 163 )
hint_tooltip = "Your current food quality"
mouse_default_cursor_shape = 2
icon = ExtResource( 17 )
icon_align = 1

[node name="Label" type="Label" parent="FoodUpgradeButton"]
margin_top = 64.0
margin_right = 200.0
margin_bottom = 100.0
text = "Food Quality: $2.50"
align = 1
valign = 1

[node name="WaterGunUpgradeButton" type="Button" parent="."]
margin_left = 983.0
margin_top = 25.0
margin_right = 1183.0
margin_bottom = 125.0
rect_pivot_offset = Vector2( 108, 163 )

[node name="FarmButton" type="Button" parent="."]
margin_left = 1193.0
margin_top = 25.0
margin_right = 1393.0
margin_bottom = 125.0
rect_pivot_offset = Vector2( 108, 163 )

[node name="CollectGuano" type="AudioStreamPlayer" parent="."]
stream = ExtResource( 9 )

[node name="FoodDrop" type="AudioStreamPlayer" parent="."]
stream = ExtResource( 11 )

[node name="BuyBat" type="AudioStreamPlayer" parent="."]
stream = ExtResource( 10 )

[node name="Click" type="AudioStreamPlayer" parent="."]
stream = ExtResource( 12 )

[node name="Rain" type="AudioStreamPlayer" parent="."]
stream = ExtResource( 13 )

[node name="Piano" type="AudioStreamPlayer" parent="."]
stream = ExtResource( 14 )

[node name="TextureRect" type="TextureRect" parent="."]
margin_left = 25.0
margin_top = 25.0
margin_right = 343.0
margin_bottom = 125.0
texture = ExtResource( 16 )

[node name="NoMoney" type="AnimationPlayer" parent="TextureRect"]
reset_on_save = false
anims/NoMoney = SubResource( 5 )

[node name="MoneyLabel" type="Label" parent="."]
margin_left = 36.0
margin_top = 36.0
margin_right = 333.0
margin_bottom = 115.0
hint_tooltip = "Your available money"
mouse_filter = 0
text = "Money: $2.00"
align = 1
valign = 1
script = ExtResource( 8 )

[connection signal="child_entered_tree" from="." to="." method="_on_Main_child_entered_tree"]
[connection signal="child_exiting_tree" from="." to="." method="_on_Main_child_exiting_tree"]
[connection signal="area_entered" from="CanvasLayer/BottomScreen" to="." method="_on_BottomScreen_area_entered"]
[connection signal="area_entered" from="Mouse" to="." method="_on_Mouse_area_entered"]
[connection signal="area_exited" from="Mouse" to="." method="_on_Mouse_area_exited"]
[connection signal="pressed" from="BatButton" to="." method="_on_BatButton_pressed"]
[connection signal="pressed" from="FoodDropQuantityButton" to="." method="_on_FoodDropQuantityButton_pressed"]
[connection signal="pressed" from="FoodUpgradeButton" to="." method="_on_FoodUpgradeButton_pressed"]
